{{- if .Values.alembic.enabled -}}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ template "chartreuse.fullname" . }}-config-ephemeral
  labels:
    app: {{ template "chartreuse.name" . }}
    chart: {{ template "chartreuse.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    helm.sh/release-time: {{ now | unixEpoch | quote }}
    {{- include "chartreuse.labels" . | nindent 4 }}
  annotations:
    {{- include "chartreuse.annotations.ephemeral" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.alembic.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.alembic.externalSecrets.storeRef.kind }}
    name: {{ .Values.alembic.externalSecrets.storeRef.name }}
  target:
    name: {{ template "chartreuse.fullname" . }}-config-ephemeral
    template:
      engineVersion: v2
      data:
        chartreuse-config.yaml: |
          # Chartreuse Multi-Database Configuration
          # 
          # This YAML file defines multiple databases that Chartreuse should manage.
          # Database names are used as keys for easy organization.

          databases:
          {{- range $dbName, $dbConfig := .Values.alembic.database_list }}
            # {{ $dbName | title }} database
            {{ $dbName }}:
              alembic_directory_path: {{ $dbConfig.directoryPath | default $.Values.alembic.directoryPath | quote }}
              alembic_config_file_path: {{ $dbConfig.configPath | default $.Values.alembic.configPath | quote }}
              # Database connection components (URL will be built automatically)
              dialect: {{ $dbConfig.dialect | quote }}
              user: {{ $dbConfig.user | quote }}
              password: {{ printf "{{ .%s }}" ($dbConfig.passwordRemoteRefKey | replace "-" "_" | upper) }}
              host: {{ $dbConfig.host | quote }}
              port: {{ $dbConfig.port }}
              database: {{ $dbConfig.database | quote }}
              allow_migration_for_empty_database: {{ $dbConfig.allowMigrationFromEmptyDatabase | default $.Values.alembic.allowMigrationFromEmptyDatabase }}
              additional_parameters: {{ $dbConfig.additionalParameters | default $.Values.alembic.additionalParameters | quote }}
              is_patroni_postgresql: {{ $dbConfig.is_patroni_postgresql }}
          {{- end }}
        {{- $secrets := dict }}
        {{- range $dbName, $dbConfig := .Values.alembic.database_list }}
          {{- $_ := set $secrets $dbConfig.passwordRemoteRefKey $dbConfig.passwordRemoteRefKey }}
        {{- end }}
        {{- range $key, $remoteKey := $secrets }}
        {{ $key | replace "-" "_" | upper }}: "{{ printf "{{ .%s }}" ($key | replace "-" "_" | upper) }}"
        {{- end }}
  data:
  {{- $secrets := dict }}
  {{- range $dbName, $dbConfig := .Values.alembic.database_list }}
    {{- $_ := set $secrets $dbConfig.passwordRemoteRefKey $dbConfig.passwordRemoteRefKey }}
  {{- end }}
  {{- range $key, $remoteKey := $secrets }}
    - secretKey: {{ $key | replace "-" "_" | upper }}
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: {{ $remoteKey }}
        metadataPolicy: None
  {{- end }}
{{- end -}}
