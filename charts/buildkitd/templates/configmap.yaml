apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "buildkitd.fullname" . }}
  labels:
    app: {{ template "buildkitd.fullname" . }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  # See: https://docs.docker.com/build/buildkit/toml-configuration/
  config.toml: |
    group = 1000
    # Needed for liveness & readiness probes
    debug = true
    rootless = true

    [grpc]
    address = [ "tcp://0.0.0.0:{{ .Values.config.port }}" ]

    [worker.oci]
    enabled = true
    rootless = true
    platforms = {{ .Values.config.workerOci.platforms }}
    snapshotter = {{ .Values.config.workerOci.snapshotter }}
    # Whether run subprocesses in main pid namespace or not, this is useful for
    # running rootless buildkit inside a container.
    noProcessSandbox = true
    {{- if .Values.config.workerOci.maxParallelism }}
    max-parallelism = {{ .Values.config.workerOci.maxParallelism }}
    {{- end }}
    {{- if .Values.config.gc.enabled }}
    gc = true
    gckeepstorage = {{ floor (mulf (mulf (trimSuffix "Gi" .Values.persistence.size) 1024) .Values.config.gc.keepstoragePercentage) }}
    {{- else }}
    gc = false
    {{- end }}

    [worker.containerd]
    enabled = false

    # config for build history API that stores information about completed
    # build commands
    [history]
    # maxAge is the maximum age of history entries to keep, in seconds.
    maxAge = {{ .Values.config.history.maxAge }}
    # maxEntries is the maximum number of history entries to keep.
    maxEntries = {{ .Values.config.history.maxEntries }}
